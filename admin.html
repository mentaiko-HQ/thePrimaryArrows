<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é‹å–¶ç®¡ç† | ã‚¹ã‚³ã‚¢å…¥åŠ›</title>
    <script src="config.js"></script> 
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* =========================================
           ãƒ™ãƒ¼ã‚¹è¨­å®š & ãƒªã‚»ãƒƒãƒˆ
           ========================================= */
        :root { 
            --primary: #2c3e50; 
            --accent: #e74c3c; 
            --bg: #f4f7f6; 
            --active-tab: #3498db; 
            --card-bg: #ffffff;
            --text-main: #333;
            --text-sub: #7f8c8d;
            --gap-md: 12px;
        }

        /* æœ€é‡è¦ï¼šæ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢ã®ãŸã‚ã®ãƒœãƒƒã‚¯ã‚¹ã‚µã‚¤ã‚ºè¨ˆç®—å¤‰æ›´ */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Yu Gothic", sans-serif; 
            background: var(--bg); 
            padding: 10px; 
            margin: 0; 
            color: var(--text-main);
            /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¼·åˆ¶æ’é™¤ */
            overflow-x: hidden;
            padding-bottom: 40px; /* ä¸‹éƒ¨ã®ä½™ç™½ */
        }
        
        .container { 
            max-width: 600px; /* ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºãªã‚‰ã“ã®ãã‚‰ã„ã®å¹…ãŒã‚¹ãƒãƒ›ã€œã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã§æœ€é© */
            margin: 0 auto; 
        }
        
        /* =========================================
           ãƒ­ã‚°ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«
           ========================================= */
        #login-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(44, 62, 80, 0.95); display: flex; justify-content: center; align-items: center; z-index: 999;
        }
        .login-box { background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 350px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        input[type="email"], input[type="password"] { width: 100%; padding: 14px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; background: #fafafa; }
        
        /* =========================================
           ãƒ˜ãƒƒãƒ€ãƒ¼ & ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
           ========================================= */
        .header-area { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 15px; padding: 0 5px;
        }
        .app-title { margin: 0; font-size: 1.2rem; font-weight: 800; color: var(--primary); }
        .btn-logout { background: #95a5a6; color: white; border: none; padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; }

        /* ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .tab-nav { 
            display: flex; 
            background: #e0e0e0; 
            border-radius: 10px; 
            padding: 4px;
            margin-bottom: 15px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }
        .tab-btn {
            flex: 1;
            border: none;
            background: transparent;
            padding: 10px 4px;
            font-size: 0.85rem;
            font-weight: bold;
            color: var(--text-sub);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            line-height: 1.2;
        }
        .tab-btn small { font-size: 0.7rem; opacity: 0.8; }
        .tab-btn.active {
            background: white;
            color: var(--active-tab);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ */
        .search-area { margin-bottom: 20px; }
        .search-input { 
            width: 100%; padding: 12px 16px; font-size: 1rem; 
            border: none; border-radius: 12px; outline: none; 
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: box-shadow 0.2s;
        }
        .search-input:focus { box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2); }

        /* =========================================
           ã‚«ãƒ¼ãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (ãƒ¡ã‚¤ãƒ³è¡¨ç¤º)
           ========================================= */
        .card-list { display: flex; flex-direction: column; gap: 16px; }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.06);
            border: 1px solid rgba(0,0,0,0.02);
        }

        /* ã‚«ãƒ¼ãƒ‰ãƒ˜ãƒƒãƒ€ãƒ¼: åå‰ã¨ID */
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f0f0f0;
        }
        .participant-info { display: flex; align-items: center; gap: 10px; }
        .p-id { 
            background: var(--primary); color: white; 
            padding: 2px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; 
        }
        .p-name { font-size: 1.1rem; font-weight: bold; color: var(--primary); display: block; }
        .p-team { font-size: 0.8rem; color: var(--text-sub); display: block; margin-top: 2px; }
        
        .current-score-badge {
            text-align: right;
        }
        .badge-label { font-size: 0.65rem; color: #999; display: block; }
        .badge-val { font-size: 1.2rem; font-weight: 800; color: var(--accent); }

        /* =========================================
           ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ & ã‚°ãƒªãƒƒãƒ‰ã‚·ã‚¹ãƒ†ãƒ 
           ========================================= */
        
        /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯éè¡¨ç¤º */
        .content-r1, .content-r2, .content-r3, .content-total { display: none; }

        /* Bodyã®ã‚¯ãƒ©ã‚¹ã«å¿œã˜ã¦ Grid ã¨ã—ã¦è¡¨ç¤º */
        /* 1å›ç›®: 1ã‚«ãƒ©ãƒ  (ç¸¦ç©ã¿) */
        .tab-mode-r1 .content-r1 {
            display: grid;
            grid-template-columns: 1fr; /* æ¨ªã„ã£ã±ã„ */
            gap: 10px;
        }

        /* 2å›ç›®ãƒ»3å›ç›®: 2ã‚«ãƒ©ãƒ  (2åˆ—) */
        .tab-mode-r2 .content-r2,
        .tab-mode-r3 .content-r3 {
            display: grid;
            grid-template-columns: 1fr 1fr; /* 50%ãšã¤ */
            gap: 10px;
        }

        /* é›†è¨ˆ: ãƒ–ãƒ­ãƒƒã‚¯è¡¨ç¤º */
        .tab-mode-total .content-total { display: block; }


        /* =========================================
           ã‚¹ã‚³ã‚¢å…¥åŠ›ãƒœã‚¿ãƒ³
           ========================================= */
        .score-btn { 
            width: 100%; /* è¦ªã‚°ãƒªãƒƒãƒ‰ã«åˆã‚ã›ã¦åºƒãŒã‚‹ */
            padding: 12px 0;
            border-radius: 8px; 
            background: #f8f9fa; 
            border: 1px solid #eee;
            color: var(--text-main); 
            font-size: 1rem; 
            font-weight: bold;
            cursor: pointer;
            transition: all 0.1s;
        }
        
        /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .score-btn.active { 
            background: var(--active-tab); 
            color: white; 
            border-color: var(--active-tab);
            box-shadow: 0 4px 6px rgba(52, 152, 219, 0.3);
            transform: translateY(-1px);
        }
        
        /* ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ã¸ã“ã¿ */
        .score-btn:active { transform: translateY(1px); box-shadow: none; }

        /* =========================================
           é›†è¨ˆè¡¨ç¤º & ä¿å­˜ã‚¨ãƒªã‚¢
           ========================================= */
        .result-detail {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            text-align: center;
            font-size: 1rem;
            color: #555;
            margin-bottom: 10px;
        }
        .result-highlight { font-weight: bold; color: var(--accent); font-size: 1.4rem; }

        .card-actions {
            margin-top: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }
        
        .btn-save { 
            flex: 1;
            background: #27ae60; 
            border: none; 
            color: white; 
            padding: 14px; 
            font-size: 1rem; 
            border-radius: 8px; 
            font-weight: bold; 
            cursor: pointer; 
            box-shadow: 0 4px 0 #219150; /* ç«‹ä½“çš„ãªãƒœã‚¿ãƒ³ */
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .btn-save:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        .status-msg { font-size: 0.8rem; color: #888; white-space: nowrap; min-width: 40px; text-align: right; }
        .error-log { color: red; margin-top: 10px; font-size: 0.8rem; }

    </style>
</head>
<body class="tab-mode-r1"> <div id="login-overlay">
    <div class="login-box">
        <h2 style="color:var(--primary);">ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h2>
        <input type="email" id="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
        <input type="password" id="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
        <button class="btn-save" style="width:100%;" onclick="signIn()">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <div id="login-error" class="error-log"></div>
    </div>
</div>

<div class="container">
    <div class="header-area">
        <h1 class="app-title">ğŸ“ ã‚¹ã‚³ã‚¢å…¥åŠ›</h1>
        <button class="btn-logout" onclick="signOut()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>

    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab('r1', this)">1å›ç›®<br><small>(æ¨ªä¸€åˆ—)</small></button>
        <button class="tab-btn" onclick="switchTab('r2', this)">2å›ç›®<br><small>(2åˆ—)</small></button>
        <button class="tab-btn" onclick="switchTab('r3', this)">3å›ç›®<br><small>(2åˆ—)</small></button>
        <button class="tab-btn" onclick="switchTab('total', this)">é›†è¨ˆ<br><small>ç¢ºèª</small></button>
    </div>

    <div class="search-area">
        <input type="search" id="search-box" class="search-input" placeholder="ğŸ” åå‰ãƒ»æ‰€å±ã§æ¤œç´¢..." oninput="filterData()">
    </div>
    
    <div id="card-list" class="card-list">
        </div>
    
    <p id="count-display" style="text-align:center; font-size:0.8rem; color:#aaa; margin-top:20px;"></p>
</div>

<script>
    // =========================================================
    // è¨­å®š & åˆæœŸåŒ–
    // =========================================================
    const SUPABASE_URL = APP_CONFIG.URL;
    const SUPABASE_ANON_KEY = APP_CONFIG.KEY;

    let sbClient;
    let allParticipants = []; 
    let currentTab = 'r1';

    try {
        sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    } catch (e) { 
        console.error("Supabase Init Error:", e);
        alert("SupabaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: config.jsã‚’ç¢ºèªã—ã¦ãã ã•ã„"); 
    }

    // =========================================================
    // UIåˆ¶å¾¡ãƒ­ã‚¸ãƒƒã‚¯
    // =========================================================
    function switchTab(mode, btn) {
        currentTab = mode;

        // 1. bodyã®ã‚¯ãƒ©ã‚¹å¤‰æ›´ (CSS Gridã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåˆ‡ã‚Šæ›¿ãˆãƒˆãƒªã‚¬ãƒ¼)
        document.body.className = `tab-mode-${mode}`;

        // 2. ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–è¡¨ç¤º
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    // =========================================================
    // ãƒ‡ãƒ¼ã‚¿å‡¦ç†ç³»
    // =========================================================

    async function signIn() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const errorEl = document.getElementById('login-error');
        errorEl.innerText = "é€šä¿¡ä¸­...";

        try {
            const { error } = await sbClient.auth.signInWithPassword({ email, password });
            if (error) throw error;
            
            document.getElementById('login-overlay').style.display = 'none';
            fetchData(); 
        } catch (error) {
            errorEl.innerText = error.message;
        }
    }

    async function signOut() {
        await sbClient.auth.signOut();
        location.reload();
    }

    async function fetchData() {
        try {
            const { data, error } = await sbClient.from('participants').select('*').order('id');
            if (error) throw error;
            
            allParticipants = data;
            renderCards(allParticipants);
        } catch (error) {
            alert('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ' + error.message);
        }
    }

    function filterData() {
        const query = document.getElementById('search-box').value.toLowerCase();
        const filtered = allParticipants.filter(p => 
            (p.name && p.name.toLowerCase().includes(query)) || 
            (p.team && p.team.toLowerCase().includes(query)) ||
            (p.id.toString().includes(query))
        );
        renderCards(filtered);
    }

    // =========================================================
    // â˜…ã‚«ãƒ¼ãƒ‰æç”»ã‚¨ãƒ³ã‚¸ãƒ³ (æ—§ renderTable)
    // =========================================================
    function renderCards(data) {
        const container = document.getElementById('card-list');
        document.getElementById('count-display').innerText = `è¡¨ç¤ºä¸­: ${data.length}å`;
        
        if (!data || data.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#999; padding:40px;">è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
            return;
        }

        let html = '';

        data.forEach(p => {
            // --- ãƒœã‚¿ãƒ³ç”Ÿæˆãƒ˜ãƒ«ãƒ‘ãƒ¼ ---
            const createButtons = (roundKey, max, currentVal) => {
                let btns = '';
                for (let i = 0; i <= max; i++) {
                    const isActive = (i === currentVal) ? 'active' : '';
                    // ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã« selectValue ã‚’å‘¼ã¶
                    btns += `<button class="score-btn ${isActive}" onclick="selectValue(${p.id}, '${roundKey}', ${i}, this)">${i}</button>`;
                }
                // éš ã—inputã§å€¤ã‚’ä¿æŒ
                btns += `<input type="hidden" id="${roundKey}-${p.id}" value="${currentVal}">`;
                return btns;
            };

            // --- é›†è¨ˆã‚¿ãƒ–ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ ---
            const totalDisplay = `
                <div class="result-detail">
                    <div>
                        <span id="disp-r1-${p.id}">${p.round1}</span> + 
                        <span id="disp-r2-${p.id}">${p.round2}</span> + 
                        <span id="disp-r3-${p.id}">${p.round3}</span>
                    </div>
                    <div style="margin-top:5px; border-top:1px dashed #ddd; padding-top:5px;">
                        åˆè¨ˆ: <span class="result-highlight" id="disp-total-${p.id}">${p.score}</span> ç‚¹
                    </div>
                </div>
            `;

            // --- ã‚«ãƒ¼ãƒ‰HTMLæ§‹ç¯‰ ---
            html += `
            <div class="card">
                <div class="card-header">
                    <div class="participant-info">
                        <span class="p-id">No.${p.id}</span>
                        <div>
                            <span class="p-name">${p.name}</span>
                            <span class="p-team">${p.team}</span>
                        </div>
                    </div>
                    <div class="current-score-badge">
                        <span class="badge-label">TOTAL</span>
                        <span class="badge-val" id="badge-total-${p.id}">${p.score}</span>
                    </div>
                </div>

                <div class="content-r1">
                    ${createButtons('r1', 2, p.round1)}
                </div>

                <div class="content-r2">
                    ${createButtons('r2', 4, p.round2)}
                </div>

                <div class="content-r3">
                    ${createButtons('r3', 4, p.round3)}
                </div>

                <div class="content-total">
                    ${totalDisplay}
                </div>

                <div class="card-actions">
                    <span id="msg-${p.id}" class="status-msg"></span>
                    <button class="btn-save" onclick="updateScore(${p.id})">æ›´æ–°ã™ã‚‹</button>
                </div>
            </div>`;
        });

        container.innerHTML = html;
    }

    // =========================================================
    // å€¤é¸æŠ & æ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯
    // =========================================================

    function selectValue(id, roundKey, value, btnElement) {
        // 1. éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å€¤ã‚’ã‚»ãƒƒãƒˆ
        document.getElementById(`${roundKey}-${id}`).value = value;
        
        // 2. è¦‹ãŸç›®ã®æ›´æ–° (å…„å¼Ÿãƒœã‚¿ãƒ³ã®activeã‚’å¤–ã—ã¦ã€è‡ªåˆ†ã«ã¤ã‘ã‚‹)
        const parent = btnElement.parentElement;
        Array.from(parent.children).forEach(child => {
            if(child.classList.contains('score-btn')) child.classList.remove('active');
        });
        btnElement.classList.add('active');

        // 3. UIä¸Šã®è¨ˆç®—çµæœã‚’å³æ™‚æ›´æ–° (UXå‘ä¸Š)
        updateTempDisplay(id);
    }

    // ç”»é¢ä¸Šã®è¨ˆç®—ã ã‘å…ˆè¡Œã—ã¦æ›´æ–°
    function updateTempDisplay(id) {
        const r1 = parseInt(document.getElementById(`r1-${id}`).value) || 0;
        const r2 = parseInt(document.getElementById(`r2-${id}`).value) || 0;
        const r3 = parseInt(document.getElementById(`r3-${id}`).value) || 0;
        const total = r1 + r2 + r3;
        
        // é›†è¨ˆã‚¿ãƒ–å†…ã®è¡¨ç¤ºæ›´æ–°
        const elR1 = document.getElementById(`disp-r1-${id}`);
        const elR2 = document.getElementById(`disp-r2-${id}`);
        const elR3 = document.getElementById(`disp-r3-${id}`);
        const elTotal = document.getElementById(`disp-total-${id}`);
        
        // ã‚«ãƒ¼ãƒ‰å³ä¸Šã®ãƒãƒƒã‚¸æ›´æ–°
        const badgeTotal = document.getElementById(`badge-total-${id}`);

        if(elR1) elR1.innerText = r1;
        if(elR2) elR2.innerText = r2;
        if(elR3) elR3.innerText = r3;
        if(elTotal) elTotal.innerText = total;
        if(badgeTotal) badgeTotal.innerText = total;
    }

    // ä¿å­˜å‡¦ç† (ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°å¯¾å¿œ)
    async function updateScore(id) {
        const msgEl = document.getElementById(`msg-${id}`);
        
        try {
            msgEl.innerText = "é€ä¿¡ä¸­...";
            msgEl.style.color = "#888";

            const r1 = parseInt(document.getElementById(`r1-${id}`).value) || 0;
            const r2 = parseInt(document.getElementById(`r2-${id}`).value) || 0;
            const r3 = parseInt(document.getElementById(`r3-${id}`).value) || 0;
            const newScore = r1 + r2 + r3;

            const { error } = await sbClient
                .from('participants')
                .update({ round1: r1, round2: r2, round3: r3, score: newScore })
                .eq('id', id);

            if (error) throw error;

            // æˆåŠŸæ™‚
            msgEl.innerText = "ä¿å­˜å®Œäº†!";
            msgEl.style.color = "#27ae60";

            // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–° (æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãªã©ã¸ã®åæ˜ )
            const target = allParticipants.find(p => p.id === id);
            if(target) {
                target.round1 = r1;
                target.round2 = r2;
                target.round3 = r3;
                target.score = newScore;
            }

            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ•°ç§’å¾Œã«æ¶ˆã™
            setTimeout(() => { msgEl.innerText = ""; }, 2000);

        } catch (error) {
            console.error("Update Error:", error);
            msgEl.innerText = "ã‚¨ãƒ©ãƒ¼!";
            msgEl.style.color = "red";
            alert(`ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n${error.message}`);
        }
    }

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¶­æŒç¢ºèª
    if (sbClient) {
        sbClient.auth.getSession().then(({ data: { session } }) => {
            if (session) {
                document.getElementById('login-overlay').style.display = 'none';
                fetchData();
            }
        });
    }
</script>
</body>
</html>
