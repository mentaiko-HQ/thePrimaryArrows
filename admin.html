<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‹å–¶ç®¡ç† | ã‚¹ã‚³ã‚¢å…¥åŠ›</title>
    <script src="config.js"></script> 
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #e74c3c; --bg: #f4f7f6; --active-tab: #3498db; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Yu Gothic", sans-serif; background: var(--bg); padding: 10px; margin: 0; }
        
        .container { max-width: 100%; margin: 0 auto; background: white; padding: 0; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); overflow: hidden;}
        
        /* ãƒ­ã‚°ã‚¤ãƒ³å‘¨ã‚Š */
        #login-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(44, 62, 80, 0.95); display: flex; justify-content: center; align-items: center; z-index: 999;
        }
        .login-box { background: white; padding: 30px; border-radius: 8px; width: 90%; max-width: 350px; text-align: center; }
        input[type="email"], input[type="password"] { width: 100%; padding: 12px; margin-bottom: 15px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¨ãƒªã‚¢ */
        .header-area { padding: 15px; display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .btn-logout { background: #7f8c8d; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; cursor: pointer; }

        /* â˜…ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .tab-nav { display: flex; background: #eee; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .tab-btn {
            flex: 1;
            border: none;
            background: #eee;
            padding: 12px 5px;
            font-size: 0.9rem;
            font-weight: bold;
            color: #7f8c8d;
            cursor: pointer;
            white-space: nowrap;
            border-bottom: 4px solid transparent;
            transition: all 0.2s;
        }
        .tab-btn.active {
            background: white;
            color: var(--primary);
            border-bottom-color: var(--active-tab);
        }

        /* æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ */
        .search-area { padding: 10px; border-bottom: 1px solid #eee; background: white; }
        .search-input { width: 100%; padding: 10px; font-size: 1rem; border: 2px solid #ddd; border-radius: 25px; outline: none; box-sizing: border-box; }
        .search-input:focus { border-color: var(--active-tab); }

        /* ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®š */
        .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; max-height: 65vh; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 100%; }
        th, td { padding: 12px 8px; border-bottom: 1px solid #eee; text-align: center; vertical-align: middle; }
        th { background: var(--primary); color: white; font-size: 0.85rem; white-space: nowrap; position: sticky; top: 0; z-index: 5; }
        td { font-size: 0.95rem; }
        
        .col-name { text-align: left; min-width: 110px; max-width: 150px; }
        .col-input { min-width: 180px; } /* å…¥åŠ›ã‚¨ãƒªã‚¢ã®å¹…ç¢ºä¿ */
        .col-action { width: 70px; }

        /* åå‰ãƒ»æ‰€å± */
        .p-name { display: block; font-weight: bold; color: #333; line-height: 1.2; }
        .p-team { display: block; font-size: 0.75rem; color: #888; margin-top: 2px; }

        /* ã‚¹ã‚³ã‚¢é¸æŠãƒœã‚¿ãƒ³ */
        .score-selector { display: flex; gap: 6px; justify-content: center; width: fit-content; margin: 0 auto; }
        .score-btn { 
            width: 36px; height: 36px; /* ãƒœã‚¿ãƒ³ã‚’å¤§ããæŠ¼ã—ã‚„ã™ã */
            border-radius: 6px; background: #f0f0f0; border: none;
            color: #333; font-size: 1.1rem; font-weight: bold;
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer;
            box-shadow: 0 2px 0 rgba(0,0,0,0.1);
        }
        .score-btn.active { background: var(--active-tab); color: white; box-shadow: none; transform: translateY(2px); }

        /* é›†è¨ˆè¡¨ç¤ºç”¨ */
        .result-view { font-family: monospace; font-size: 0.9rem; color: #666; }
        .result-total { font-size: 1.4rem; font-weight: bold; color: var(--accent); margin-left: 10px; }

        /* ä¿å­˜ãƒœã‚¿ãƒ³ */
        .btn-save { background: #27ae60; border: none; color: white; padding: 8px 0; font-size: 0.8rem; width: 100%; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .status-msg { font-size: 0.7rem; color: #888; display: block; margin-top: 2px; min-height: 1em; }
        .error-log { color: red; margin-top: 10px; font-size: 0.8rem; }

        /* â˜…ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆåˆ¶å¾¡ (CSSã§è¡¨ç¤ºéè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹) */
        /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å…¨éƒ¨éè¡¨ç¤ºã«ã—ã¦ãŠãã€è¦ªã‚¯ãƒ©ã‚¹ã«å¿œã˜ã¦è¡¨ç¤ºã™ã‚‹ */
        .content-r1, .content-r2, .content-r3, .content-total { display: none; }
        
        /* bodyã« class="tab-mode-r1" ãŒã¤ã„ã¦ã„ã‚‹æ™‚ã¯ .content-r1 ã‚’è¡¨ç¤º */
        .tab-mode-r1 .content-r1 { display: block; }
        .tab-mode-r2 .content-r2 { display: block; }
        .tab-mode-r3 .content-r3 { display: block; }
        .tab-mode-total .content-total { display: block; }

    </style>
</head>
<body class="tab-mode-r1"> <div id="login-overlay">
    <div class="login-box">
        <h2>ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h2>
        <input type="email" id="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
        <input type="password" id="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
        <button class="btn-save" style="padding:12px; font-size:1rem;" onclick="signIn()">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <div id="login-error" class="error-log"></div>
    </div>
</div>

<div class="container">
    <div class="header-area">
        <h2 style="margin:0; font-size:1.1rem;">ğŸ“ ã‚¹ã‚³ã‚¢å…¥åŠ›</h2>
        <button class="btn-logout" onclick="signOut()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>

    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab('r1', this)">1å›ç›®<br><small>(0-2)</small></button>
        <button class="tab-btn" onclick="switchTab('r2', this)">2å›ç›®<br><small>(0-4)</small></button>
        <button class="tab-btn" onclick="switchTab('r3', this)">3å›ç›®<br><small>(0-4)</small></button>
        <button class="tab-btn" onclick="switchTab('total', this)">é›†è¨ˆ<br><small>æˆç¸¾ç¢ºèª</small></button>
    </div>

    <div class="search-area">
        <input type="search" id="search-box" class="search-input" placeholder="ğŸ” é¸æ‰‹åã§æ¤œç´¢..." oninput="filterData()">
    </div>
    
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th style="width:40px;">No.</th>
                    <th class="col-name">é¸æ‰‹å</th>
                    <th class="col-input" id="dynamic-header">1å›ç›®æˆç¸¾</th> <th class="col-action">æ›´æ–°</th>
                </tr>
            </thead>
            <tbody id="admin-tbody"></tbody>
        </table>
    </div>
    <p id="count-display" style="text-align:right; font-size:0.8rem; color:#888; padding:0 10px;"></p>
</div>

<script>
    // =========================================================
    // è¨­å®šã‚¨ãƒªã‚¢
    // =========================================================
    const SUPABASE_URL = APP_CONFIG.URL;
    const SUPABASE_ANON_KEY = APP_CONFIG.KEY;

    let sbClient;
    let allParticipants = []; 
    let currentTab = 'r1'; // ç¾åœ¨ã®ã‚¿ãƒ–ã‚’è¨˜æ†¶

    try {
        sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    } catch (e) { alert("SupabaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼"); }

    // =========================================================
    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆãƒ­ã‚¸ãƒƒã‚¯ (UI/UXã®è‚)
    // =========================================================
    function switchTab(mode, btn) {
        currentTab = mode;

        // 1. ãƒœãƒ‡ã‚£ã®ã‚¯ãƒ©ã‚¹ã‚’æ›¸ãæ›ãˆã¦ã€CSSã§è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’ä¸€æ‹¬åˆ‡ã‚Šæ›¿ãˆ
        document.body.className = `tab-mode-${mode}`;

        // 2. ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®è¦‹ãŸç›®ã‚’æ›´æ–°
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        // 3. ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ã®æ–‡å­—ã‚’å¤‰æ›´
        const headerText = {
            'r1': '1å›ç›®æˆç¸¾ (0-2)',
            'r2': '2å›ç›®æˆç¸¾ (0-4)',
            'r3': '3å›ç›®æˆç¸¾ (0-4)',
            'total': 'æˆç¸¾è©³ç´°'
        };
        document.getElementById('dynamic-header').innerText = headerText[mode];
    }

    // =========================================================
    // ãƒ‡ãƒ¼ã‚¿å‡¦ç†ç³»
    // =========================================================

    async function signIn() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const errorEl = document.getElementById('login-error');
        errorEl.innerText = "é€šä¿¡ä¸­...";

        const { error } = await sbClient.auth.signInWithPassword({ email, password });
        if (error) {
            errorEl.innerText = error.message;
        } else {
            document.getElementById('login-overlay').style.display = 'none';
            fetchData(); 
        }
    }

    async function signOut() {
        await sbClient.auth.signOut();
        location.reload();
    }

    async function fetchData() {
        // IDé †ã§å…¨ãƒ‡ãƒ¼ã‚¿å–å¾—
        const { data, error } = await sbClient.from('participants').select('*').order('id');
        if (error) return alert('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ' + error.message);
        
        allParticipants = data;
        renderTable(allParticipants);
    }

    function filterData() {
        const query = document.getElementById('search-box').value.toLowerCase();
        const filtered = allParticipants.filter(p => 
            (p.name && p.name.toLowerCase().includes(query)) || 
            (p.team && p.team.toLowerCase().includes(query)) ||
            (p.id.toString().includes(query))
        );
        renderTable(filtered);
    }

    // ãƒ†ãƒ¼ãƒ–ãƒ«æç”» (å…¨ã‚¿ãƒ–åˆ†ã®è¦ç´ ã‚’äºˆã‚ä½œã£ã¦ãŠã)
    function renderTable(data) {
        const tbody = document.getElementById('admin-tbody');
        document.getElementById('count-display').innerText = `è¡¨ç¤º: ${data.length}å`;
        
        let html = '';
        if (!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="padding:20px;">è©²å½“ãªã—</td></tr>';
            return;
        }

        data.forEach(p => {
            // ãƒœã‚¿ãƒ³ç”Ÿæˆãƒ˜ãƒ«ãƒ‘ãƒ¼
            const createButtons = (roundKey, max, currentVal, tabClass) => {
                let btns = `<div class="${tabClass} score-selector">`; // ã‚¯ãƒ©ã‚¹ã§è¡¨ç¤ºåˆ¶å¾¡
                for (let i = 0; i <= max; i++) {
                    const isActive = (i === currentVal) ? 'active' : '';
                    btns += `<button class="score-btn ${isActive}" onclick="selectValue(${p.id}, '${roundKey}', ${i}, this)">${i}</button>`;
                }
                // éš ã—inputã§å€¤ã‚’ä¿æŒ
                btns += `<input type="hidden" id="${roundKey}-${p.id}" value="${currentVal}">`;
                btns += `</div>`;
                return btns;
            };

            // é›†è¨ˆã‚¿ãƒ–ã®è¡¨ç¤ºå†…å®¹
            const totalDisplay = `
                <div class="content-total">
                    <span class="result-view">
                        <span id="disp-r1-${p.id}">${p.round1}</span> + 
                        <span id="disp-r2-${p.id}">${p.round2}</span> + 
                        <span id="disp-r3-${p.id}">${p.round3}</span> = 
                    </span>
                    <span class="result-total" id="disp-total-${p.id}">${p.score}</span>
                </div>
            `;

            html += `
            <tr>
                <td>${p.id}</td>
                <td class="col-name">
                    <span class="p-name">${p.name}</span>
                    <span class="p-team">${p.team}</span>
                </td>
                <td class="col-input">
                    ${createButtons('r1', 2, p.round1, 'content-r1')}
                    
                    ${createButtons('r2', 4, p.round2, 'content-r2')}
                    
                    ${createButtons('r3', 4, p.round3, 'content-r3')}
                    
                    ${totalDisplay}
                </td>
                <td class="col-action">
                    <button class="btn-save" onclick="updateScore(${p.id})">æ›´æ–°</button>
                    <span id="msg-${p.id}" class="status-msg"></span>
                </td>
            </tr>`;
        });
        tbody.innerHTML = html;
    }

    // å€¤é¸æŠæ™‚ã®å‡¦ç†
    function selectValue(id, roundKey, value, btnElement) {
        // 1. å€¤ã®ã‚»ãƒƒãƒˆ
        document.getElementById(`${roundKey}-${id}`).value = value;
        
        // 2. è¦‹ãŸç›®ã®æ›´æ–° (activeã‚¯ãƒ©ã‚¹ä»˜ã‘æ›¿ãˆ)
        const parent = btnElement.parentElement;
        parent.querySelectorAll('.score-btn').forEach(b => b.classList.remove('active'));
        btnElement.classList.add('active');

        // 3. UIä¸Šã®é›†è¨ˆè¡¨ç¤ºã‚’ä»®æ›´æ–° (ä¿å­˜å‰ã§ã‚‚è¨ˆç®—çµæœãŒè¦‹ãˆã‚‹ã‚ˆã†ã«)
        updateTempDisplay(id);
    }

    // ç”»é¢ä¸Šã®è¨ˆç®—ã ã‘å…ˆè¡Œã—ã¦æ›´æ–° (UXå‘ä¸Š)
    function updateTempDisplay(id) {
        const r1 = parseInt(document.getElementById(`r1-${id}`).value) || 0;
        const r2 = parseInt(document.getElementById(`r2-${id}`).value) || 0;
        const r3 = parseInt(document.getElementById(`r3-${id}`).value) || 0;
        
        // é›†è¨ˆã‚¿ãƒ–ã®æ•°å­—ã‚’æ›¸ãæ›ãˆ
        const elR1 = document.getElementById(`disp-r1-${id}`);
        const elR2 = document.getElementById(`disp-r2-${id}`);
        const elR3 = document.getElementById(`disp-r3-${id}`);
        const elTotal = document.getElementById(`disp-total-${id}`);

        if(elR1) elR1.innerText = r1;
        if(elR2) elR2.innerText = r2;
        if(elR3) elR3.innerText = r3;
        if(elTotal) elTotal.innerText = (r1 + r2 + r3);
    }

    // ä¿å­˜å‡¦ç† (ã©ã®ã‚¿ãƒ–ã«ã„ã¦ã‚‚ã€ãã®äººã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹)
    async function updateScore(id) {
        const r1 = parseInt(document.getElementById(`r1-${id}`).value) || 0;
        const r2 = parseInt(document.getElementById(`r2-${id}`).value) || 0;
        const r3 = parseInt(document.getElementById(`r3-${id}`).value) || 0;
        const newScore = r1 + r2 + r3;
        
        const msgEl = document.getElementById(`msg-${id}`);
        msgEl.innerText = "é€ä¿¡ä¸­"; // çŸ­ã‚ã«

        const { error } = await sbClient
            .from('participants')
            .update({ round1: r1, round2: r2, round3: r3, score: newScore })
            .eq('id', id);

        if (error) {
            msgEl.innerText = "ã‚¨ãƒ©ãƒ¼";
            msgEl.style.color = "red";
        } else {
            msgEl.innerText = "å®Œäº†";
            msgEl.style.color = "green";
            
            // ãƒ¡ãƒ¢ãƒªå†…ã®ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–° (æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ç­‰ã«å³åæ˜ ã•ã›ã‚‹ãŸã‚)
            const target = allParticipants.find(p => p.id === id);
            if(target) {
                target.round1 = r1;
                target.round2 = r2;
                target.round3 = r3;
                target.score = newScore;
            }

            // å°‘ã—çµŒã£ãŸã‚‰æ¶ˆã™
            setTimeout(() => { msgEl.innerText = ""; }, 1500);
        }
    }

    if (sbClient) {
        sbClient.auth.getSession().then(({ data: { session } }) => {
            if (session) {
                document.getElementById('login-overlay').style.display = 'none';
                fetchData();
            }
        });
    }
</script>
</body>
</html>

