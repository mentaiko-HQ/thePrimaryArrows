<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é‹å–¶ç®¡ç† | ã‚¹ã‚³ã‚¢å…¥åŠ›</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      :root {
        --primary: #2c3e50;
        --bg: #f4f7f6;
      }
      body {
        font-family: sans-serif;
        background: var(--bg);
        padding: 20px;
      }
      .container {
        max-width: 900px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }

      /* ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ  */
      #login-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(44, 62, 80, 0.95);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 999;
      }
      .login-box {
        background: white;
        padding: 30px;
        border-radius: 8px;
        width: 300px;
        text-align: center;
      }
      input {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        box-sizing: border-box;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      button {
        background: var(--primary);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        width: 100%;
      }
      button:hover {
        opacity: 0.9;
      }

      /* ãƒ†ãƒ¼ãƒ–ãƒ« */
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      th,
      td {
        padding: 12px;
        border-bottom: 1px solid #eee;
        text-align: left;
      }
      th {
        background: var(--primary);
        color: white;
      }

      /* å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ */
      .input-mato {
        width: 80px;
        font-family: monospace;
        letter-spacing: 2px;
        text-align: center;
      }
      .btn-save {
        background: #27ae60;
        width: auto;
        font-size: 0.8rem;
      }
      .status-msg {
        font-size: 0.8rem;
        margin-left: 10px;
        color: #888;
      }
    </style>
  </head>
  <body>
    <div id="login-overlay">
      <div class="login-box">
        <h2>ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h2>
        <input type="email" id="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" />
        <input type="password" id="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" />
        <button onclick="signIn()">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <p
          id="login-error"
          style="color: red; font-size: 0.8rem; margin-top: 10px"
        ></p>
      </div>
    </div>

    <div class="container">
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
        "
      >
        <h2>ğŸ“ ã‚¹ã‚³ã‚¢ç®¡ç†</h2>
        <button onclick="signOut()" style="width: auto; background: #7f8c8d">
          ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        </button>
      </div>

      <table>
        <thead>
          <tr>
            <th>No.</th>
            <th>é¸æ‰‹å</th>
            <th>1å›ç›® (ä¾‹:â—‹â—‹Ã—â—‹)</th>
            <th>2å›ç›®</th>
            <th>çš„ä¸­æ•°</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="admin-tbody"></tbody>
      </table>
    </div>

    <script>
      // â–¼â–¼â–¼ ã“ã“ã‚’æ›¸ãæ›ãˆã¦ãã ã•ã„ â–¼â–¼â–¼
      const SUPABASE_URL = 'https://aetenreumweohzjqqcpf.supabase.co';
      const SUPABASE_ANON_KEY = 'sb_publishable__0UiwcqGL8b6OwX828Lh0A_eteYgUoi';
      // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

      const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
      async function signIn() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const { data, error } = await supabase.auth.signInWithPassword({
          email,
          password,
        });

        if (error) {
          document.getElementById('login-error').innerText =
            'ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: ' + error.message;
        } else {
          document.getElementById('login-overlay').style.display = 'none';
          fetchData(); // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹
        }
      }

      // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
      async function signOut() {
        await supabase.auth.signOut();
        location.reload();
      }

      // ãƒ‡ãƒ¼ã‚¿å–å¾—
      async function fetchData() {
        const { data, error } = await supabase
          .from('participants')
          .select('*')
          .order('id');
        if (error) return alert('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼');
        renderTable(data);
      }

      // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
      function renderTable(data) {
        const tbody = document.getElementById('admin-tbody');
        let html = '';
        data.forEach((p) => {
          html += `
            <tr>
                <td>${p.id}</td>
                <td>${p.name}<br><small style="color:#888">${
            p.team
          }</small></td>
                <td><input type="text" class="input-mato" id="r1-${
                  p.id
                }" value="${p.round1 || ''}" placeholder="----"></td>
                <td><input type="text" class="input-mato" id="r2-${
                  p.id
                }" value="${p.round2 || ''}" placeholder="----"></td>
                <td id="score-${p.id}" style="font-weight:bold;">${p.score}</td>
                <td>
                    <button class="btn-save" onclick="updateScore(${
                      p.id
                    })">æ›´æ–°</button>
                    <span id="msg-${p.id}" class="status-msg"></span>
                </td>
            </tr>`;
        });
        tbody.innerHTML = html;
      }

      // ã‚¹ã‚³ã‚¢æ›´æ–°å‡¦ç†
      async function updateScore(id) {
        const r1 = document.getElementById(`r1-${id}`).value;
        const r2 = document.getElementById(`r2-${id}`).value;

        // çš„ä¸­æ•°ã‚’è‡ªå‹•è¨ˆç®—ï¼ˆâ—‹ã®æ•°ã‚’æ•°ãˆã‚‹ï¼‰
        const countAtari = (str) => (str.match(/[â—‹oO0]/g) || []).length;
        const newScore = countAtari(r1) + countAtari(r2);

        // UIä¸Šã®ã‚¹ã‚³ã‚¢ã‚’ä»®æ›´æ–°
        document.getElementById(`score-${id}`).innerText = newScore;
        const msgEl = document.getElementById(`msg-${id}`);
        msgEl.innerText = 'é€ä¿¡ä¸­...';

        // Supabaseã¸ä¿å­˜
        const { error } = await supabase
          .from('participants')
          .update({ round1: r1, round2: r2, score: newScore })
          .eq('id', id);

        if (error) {
          msgEl.innerText = 'âŒ ã‚¨ãƒ©ãƒ¼';
          msgEl.style.color = 'red';
          console.error(error);
        } else {
          msgEl.innerText = 'âœ… ä¿å­˜å®Œäº†';
          msgEl.style.color = 'green';
          setTimeout(() => {
            msgEl.innerText = '';
          }, 2000);
        }
      }

      // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
      supabase.auth.getSession().then(({ data: { session } }) => {
        if (session) {
          document.getElementById('login-overlay').style.display = 'none';
          fetchData();
        }
      });
    </script>
  </body>
</html>

