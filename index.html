<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å¼“é“å¤§ä¼š ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€Ÿå ±</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      :root {
        --primary: #2c3e50;
        --accent: #e74c3c;
        --bg: #f8f9fa;
        --card-bg: #ffffff;
      }
      body {
        font-family: sans-serif;
        background: var(--bg);
        margin: 0;
        padding: 20px;
        color: #333;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
      }

      header {
        text-align: center;
        margin-bottom: 2rem;
      }
      h1 {
        margin: 0;
        color: var(--primary);
        font-size: 1.5rem;
      }
      .live-badge {
        background: var(--accent);
        color: white;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.7rem;
        vertical-align: middle;
        animation: blink 2s infinite;
      }
      @keyframes blink {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }

      /* ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ (ã‚¹ãƒãƒ›å„ªå…ˆ) */
      .card {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-left: 5px solid transparent;
        transition: transform 0.2s;
      }
      .card[data-rank='1'] {
        border-left-color: #f1c40f;
        background: #fffdf0;
      } /* 1ä½ã¯é‡‘ */
      .card[data-rank='2'] {
        border-left-color: #95a5a6;
      } /* 2ä½ã¯éŠ€ */
      .card[data-rank='3'] {
        border-left-color: #d35400;
      } /* 3ä½ã¯éŠ… */

      .player-info {
        flex: 1;
      }
      .rank {
        font-size: 0.9rem;
        color: #888;
        margin-right: 8px;
        font-weight: bold;
      }
      .name {
        font-size: 1.1rem;
        font-weight: bold;
        display: block;
      }
      .team {
        font-size: 0.8rem;
        color: #666;
      }

      .score-area {
        text-align: right;
      }
      .total-score {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--primary);
      }
      .mato-detail {
        font-size: 0.8rem;
        color: #888;
        font-family: monospace;
        letter-spacing: 2px;
      }

      .atari {
        color: var(--accent);
      }
      .hazure {
        color: #ccc;
      }

      /* èª­ã¿è¾¼ã¿ä¸­ */
      .loading {
        text-align: center;
        padding: 20px;
        color: #666;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>ğŸ¹ å¤§ä¼šé€Ÿå ± <span class="live-badge">LIVE</span></h1>
        <p style="font-size: 0.8rem; color: #666">
          ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§è‡ªå‹•æ›´æ–°ã•ã‚Œã¾ã™
        </p>
      </header>

      <div id="ranking-list">
        <div class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
      </div>
    </div>

    <script>
      // â–¼â–¼â–¼ ã“ã“ã‚’æ›¸ãæ›ãˆã¦ãã ã•ã„ â–¼â–¼â–¼
      const SUPABASE_URL = 'https://aetenreumweohzjqqcpf.supabase.co';
      const SUPABASE_ANON_KEY =
        'sb_publishable__0UiwcqGL8b6OwX828Lh0A_eteYgUoi';
      // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

      const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼†è¡¨ç¤º
      async function fetchAndRender() {
        try {
          const { data, error } = await supabase
            .from('participants')
            .select('*')
            .order('score', { ascending: false }) // ã‚¹ã‚³ã‚¢é †
            .order('id', { ascending: true }); // åŒç‚¹ãªã‚‰IDé †

          if (error) throw error;
          renderList(data);
        } catch (e) {
          console.error('Error:', e);
        }
      }

      // ãƒªã‚¹ãƒˆæç”»
      function renderList(data) {
        const container = document.getElementById('ranking-list');
        if (data.length === 0) {
          container.innerHTML =
            '<p style="text-align:center">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
          return;
        }

        let html = '';
        data.forEach((p, index) => {
          const rank = index + 1;
          const mato1 = formatMato(p.round1 || '');
          const mato2 = formatMato(p.round2 || '');

          html += `
            <div class="card" data-rank="${rank}">
                <div class="player-info">
                    <span class="rank">${rank}ä½</span>
                    <span class="name">${p.name}</span>
                    <span class="team">${p.team}</span>
                </div>
                <div class="score-area">
                    <div class="total-score">${p.score}ä¸­</div>
                    <div class="mato-detail">${mato1} | ${mato2}</div>
                </div>
            </div>`;
        });
        container.innerHTML = html;
      }

      // çš„ä¸­ãƒãƒ¼ã‚¯è£…é£¾
      function formatMato(str) {
        // å…¨è§’ãƒ»åŠè§’å¯¾å¿œ
        return str
          .replace(/[â—‹oO0]/g, '<span class="atari">â—</span>')
          .replace(/[Ã—xX]/g, '<span class="hazure">Ã—</span>');
      }

      // åˆå›å®Ÿè¡Œ
      fetchAndRender();

      // â˜…ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°è¨­å®šï¼ˆã“ã“ãŒSupabaseã®é­”æ³•ã§ã™ï¼‰
      supabase
        .channel('custom-all-channel')
        .on(
          'postgres_changes',
          { event: '*', schema: 'public', table: 'participants' },
          (payload) => {
            console.log('Change received!', payload);
            fetchAndRender(); // å¤‰æ›´ãŒã‚ã£ãŸã‚‰å†å–å¾—ã—ã¦å†æç”»
          }
        )
        .subscribe();
    </script>
  </body>
</html>
